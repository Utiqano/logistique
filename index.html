<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WTU Logistique Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDz9GlQKGuExLuLBw6Len8W4Hr0NI_hhAU",
            authDomain: "logistique-tv.firebaseapp.com",
            projectId: "logistique-tv",
            storageBucket: "logistique-tv.firebasestorage.app",
            messagingSenderId: "224411853999",
            appId: "1:224411853999:web:4cd7bc7b874daa9aa8605a",
            measurementId: "G-PY4E8TQKH9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        window.firebaseServices = { auth, db, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, collection, addDoc, getDocs };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #e63946, #4b5e6a);
        }

        .login-container, .dashboard-container, .page {
            background: #fff;
            padding: clamp(20px, 4vw, 40px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: clamp(800px, 80vw, 1600px);
            margin: 5vh auto 2vh;
            animation: fadeIn 1s ease-in-out;
            text-align: center;
            display: none;
        }

        .active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            width: clamp(80px, 10vw, 120px);
            height: auto;
            margin-bottom: 2vh;
            border-radius: 10px;
        }

        h2 {
            margin-bottom: 2vh;
            color: #4b5e6a;
            font-size: clamp(20px, 3vw, 36px);
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 2vh;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 1vh;
            color: #4b5e6a;
            font-size: clamp(14px, 2vw, 20px);
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: clamp(8px, 1.5vh, 16px);
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: clamp(14px, 2vw, 18px);
            color: #333;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group select {
            background: #fff;
            cursor: pointer;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #e63946;
            box-shadow: 0 0 8px rgba(230, 57, 70, 0.3);
        }

        .input-group input::placeholder {
            color: #aaa;
        }

        .submit-btn, .logout-btn {
            width: 100%;
            padding: clamp(8px, 1.5vh, 16px);
            background: linear-gradient(135deg, #e63946, #b32d38);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: clamp(14px, 2vw, 20px);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 2vh;
        }

        .submit-btn:hover, .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .submit-btn:active, .logout-btn:active {
            transform: translateY(0);
        }

        .forgot-password {
            text-align: center;
            margin-top: 1.5vh;
        }

        .forgot-password a {
            color: #e63946;
            text-decoration: none;
            font-size: clamp(12px, 1.5vw, 16px);
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .navbar {
            display: none;
            background: #4b5e6a;
            padding: clamp(10px, 2vh, 20px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .navbar.active {
            display: block;
        }

        .nav-container {
            max-width: clamp(1000px, 90vw, 1800px);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2vw;
        }

        .navbar ul {
            list-style: none;
            display: flex;
            gap: clamp(10px, 2vw, 20px);
        }

        .navbar ul li a {
            color: #fff;
            text-decoration: none;
            font-size: clamp(14px, 2vw, 20px);
            font-weight: 500;
            padding: clamp(6px, 1vh, 12px) clamp(8px, 1vw, 16px);
            transition: color 0.3s;
        }

        .navbar ul li a:hover {
            color: #e63946;
        }

        .hamburger {
            display: none;
            font-size: clamp(20px, 3vw, 28px);
            color: #fff;
            cursor: pointer;
        }

        canvas {
            width: 100% !important;
            height: clamp(300px, 40vh, 600px) !important;
            max-width: 100%;
            margin: 2vh auto;
        }

        @media (max-width: 768px) {
            .navbar ul {
                display: none;
                flex-direction: column;
                position: absolute;
                top: clamp(60px, 8vh, 80px);
                left: 0;
                width: 100%;
                background: #4b5e6a;
                padding: 2vh;
                transition: transform 0.3s ease-in-out;
                transform: translateY(-100%);
            }

            .navbar ul.active {
                display: flex;
                transform: translateY(0);
            }

            .hamburger {
                display: block;
            }

            .login-container, .dashboard-container, .page {
                padding: clamp(15px, 4vw, 30px);
                max-width: 95%;
            }

            .logo {
                width: clamp(60px, 15vw, 80px);
            }

            canvas {
                height: clamp(250px, 35vh, 400px) !important;
            }
        }

        @media (max-width: 480px) {
            h2 {
                font-size: clamp(16px, 4vw, 24px);
            }

            .input-group input, .input-group select {
                padding: clamp(6px, 1vh, 12px);
                font-size: clamp(12px, 3vw, 16px);
            }

            .submit-btn, .logout-btn {
                padding: clamp(6px, 1vh, 12px);
                font-size: clamp(12px, 3vw, 16px);
            }

            canvas {
                height: clamp(200px, 30vh, 350px) !important;
            }
        }

        @media (min-width: 1920px) {
            .login-container, .dashboard-container, .page {
                max-width: clamp(1200px, 85vw, 2000px);
                padding: clamp(30px, 3vw, 50px);
            }

            canvas {
                height: clamp(400px, 45vh, 800px) !important;
            }

            h2 {
                font-size: clamp(28px, 3vw, 48px);
            }

            .input-group label, .input-group input, .input-group select, .submit-btn, .logout-btn {
                font-size: clamp(18px, 2vw, 24px);
            }

            .navbar ul li a {
                font-size: clamp(18px, 2vw, 24px);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="hamburger" id="hamburger">â˜°</div>
            <ul id="nav-menu">
                <li><a href="#" onclick="showPage('page1')">Avancement export</a></li>
                <li><a href="#" onclick="showPage('page2')">Accident de travail</a></li>
                <li><a href="#" onclick="showPage('page3')">Incident Logistique</a></li>
                <li><a href="#" onclick="showPage('page4')">Suivi Remplissage Camion</a></li>
                <li><a href="#" onclick="showPage('page5')">Total Transportation Cost (% vs Sales)</a></li>
                <li><a href="#" onclick="showPage('page6')">Exceptionnel Transport (Cost)</a></li>
                <li><a href="#" onclick="showPage('page7')">Customer Service Rate</a></li>
                <li><a href="#" onclick="showPage('page8')">Taux de Respect Planning</a></li>
                <li><a href="#" onclick="showPage('page9')">Suivi 5S</a></li>
                <li><a href="#" onclick="showPage('page10')">Suivi Gemba OJT</a></li>
            </ul>
        </div>
    </nav>
    <div class="login-container active" id="login-container">
        <img src="https://media.licdn.com/dms/image/C510BAQFv4NwvhYRq8Q/company-logo_200_200/0/1519870868642?e=2147483647&v=beta&t=z3V0dxSmuHQVdnDvjOE5MTzQPHT_T-6MpMOs_SrSvYY" alt="CRRE Logo" class="logo">
        <h2>Login to CRRE</h2>
        <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="e.g. logistique@wkw.com" required>
        </div>
        <div class="input-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password" required>
        </div>
        <button class="submit-btn" onclick="handleLogin()">Sign In</button>
        <div class="forgot-password">
            <a href="#" onclick="resetPassword()">Forgot Password?</a>
        </div>
    </div>
    <div class="dashboard-container" id="dashboard">
        <img src="https://media.licdn.com/dms/image/C510BAQFv4NwvhYRq8Q/company-logo_200_200/0/1519870868642?e=2147483647&v=beta&t=z3V0dxSmuHQVdnDvjOE5MTzQPHT_T-6MpMOs_SrSvYY" alt="CRRE Logo" class="logo">
        <h2>Tableau de Bord WTU Logistique</h2>
        <p>Welcome to the WTU Logistique Dashboard</p>
        <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
    </div>
    <div class="page" id="page1">
        <h2>Avancement export</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="article">Article</label>
                <input type="text" id="article" placeholder="Enter Article">
            </div>
            <div class="input-group">
                <label for="besoin">QuantitÃ© PlanifiÃ©e</label>
                <input type="number" id="besoin" placeholder="Enter QuantitÃ© PlanifiÃ©e" min="1">
            </div>
            <div class="input-group">
                <label for="quantite">QuantitÃ© RÃ©alisÃ©e</label>
                <input type="number" id="quantite" placeholder="Enter QuantitÃ© RÃ©alisÃ©e" min="0">
            </div>
            <div class="input-group">
                <label for="reste">Reste</label>
                <input type="number" id="reste" placeholder="Enter Reste" min="0">
            </div>
            <div class="input-group">
                <label for="mois-export">Mois</label>
                <select id="mois-export" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <button class="submit-btn" onclick="submitExportData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="exportChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page2">
        <h2>Accident de travail</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-accident">Mois</label>
                <select id="mois-accident" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-accident">Pourcentage</label>
                <input type="number" id="pourcentage-accident" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitAccidentData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="accidentChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page3">
        <h2>Incident Logistique</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-incident">Mois</label>
                <select id="mois-incident" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-incident">Pourcentage</label>
                <input type="number" id="pourcentage-incident" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitIncidentData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="incidentChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page4">
        <h2>Suivi Remplissage Camion</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-camion">Mois</label>
                <select id="mois-camion" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-camion">Pourcentage</label>
                <input type="number" id="pourcentage-camion" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitCamionData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="camionChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page5">
        <h2>Total Transportation Cost (% vs Sales)</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-transport-cost">Mois</label>
                <select id="mois-transport-cost" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-transport-cost">Pourcentage</label>
                <input type="number" id="pourcentage-transport-cost" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitTransportCostData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="transportCostChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page6">
        <h2>Exceptionnel Transport (Cost)</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-exceptionnel">Mois</label>
                <select id="mois-exceptionnel" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-exceptionnel">Pourcentage</label>
                <input type="number" id="pourcentage-exceptionnel" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitExceptionnelData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="exceptionnelChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page7">
        <h2>Customer Service Rate</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-customer-service">Mois</label>
                <select id="mois-customer-service" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-customer-service">Pourcentage</label>
                <input type="number" id="pourcentage-customer-service" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitCustomerServiceData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="customerServiceChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page8">
        <h2>Taux de Respect Planning</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-planning">Mois</label>
                <select id="mois-planning" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-planning">Pourcentage</label>
                <input type="number" id="pourcentage-planning" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitPlanningData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="planningChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page9">
        <h2>Suivi 5S</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-5s">Mois</label>
                <select id="mois-5s" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-5s">Pourcentage</label>
                <input type="number" id="pourcentage-5s" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submit5SData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="fiveSChart" class="user-only"></canvas>
    </div>
    <div class="page" id="page10">
        <h2>Suivi Gemba OJT</h2>
        <div class="logistique-inputs">
            <div class="input-group">
                <label for="mois-gemba">Mois</label>
                <select id="mois-gemba" required>
                    <option value="" disabled selected>Choisir Mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="FÃ©vrier">FÃ©vrier</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="AoÃ»t">AoÃ»t</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="DÃ©cembre">DÃ©cembre</option>
                </select>
            </div>
            <div class="input-group">
                <label for="pourcentage-gemba">Pourcentage</label>
                <input type="number" id="pourcentage-gemba" placeholder="Enter Pourcentage" min="0" max="100">
            </div>
            <button class="submit-btn" onclick="submitGembaData()">Submit</button>
            <button class="logout-btn logistique-only" onclick="handleLogout()">Logout</button>
        </div>
        <canvas id="gembaChart" class="user-only"></canvas>
    </div>
    <script>
        // Global variables
        let currentChart = null;
        let userRole = null;
        let pageCycleInterval = null;
        let currentPage = 'dashboard';
        let firebaseServices = null;

        // Month mapping: French (UI) to English abbreviation (Firestore)
        const monthMapping = {
            'Janvier': 'Jan',
            'FÃ©vrier': 'Feb',
            'Mars': 'Mar',
            'Avril': 'Apr',
            'Mai': 'May',
            'Juin': 'Jun',
            'Juillet': 'Jul',
            'AoÃ»t': 'Aug',
            'Septembre': 'Sep',
            'Octobre': 'Oct',
            'Novembre': 'Nov',
            'DÃ©cembre': 'Dec'
        };

        // Default data structure for initialization
        const defaultData = {
            export: [
                { mois: 'Jan', article: 'Item1', besoin: 100, quantite: 80, reste: 20 },
                { mois: 'Feb', article: 'Item2', besoin: 120, quantite: 90, reste: 30 },
                { mois: 'Mar', article: 'Item3', besoin: 150, quantite: 120, reste: 30 },
                { mois: 'Apr', article: 'Item4', besoin: 200, quantite: 180, reste: 20 },
                { mois: 'May', article: 'Item5', besoin: 180, quantite: 150, reste: 30 },
                { mois: 'Jun', article: 'Item6', besoin: 140, quantite: 100, reste: 40 }
            ],
            accident: [
                { mois: 'Jan', pourcentage: 10 },
                { mois: 'Feb', pourcentage: 15 },
                { mois: 'Mar', pourcentage: 5 },
                { mois: 'Apr', pourcentage: 8 },
                { mois: 'May', pourcentage: 12 },
                { mois: 'Jun', pourcentage: 10 },
                { mois: 'Jul', pourcentage: 7 },
                { mois: 'Aug', pourcentage: 9 },
                { mois: 'Sep', pourcentage: 11 },
                { mois: 'Oct', pourcentage: 13 },
                { mois: 'Nov', pourcentage: 6 },
                { mois: 'Dec', pourcentage: 8 }
            ],
            incident: [{ mois: 'Jan', pourcentage: 0 }],
            camion: [{ mois: 'Jan', pourcentage: 0 }],
            transportCost: [{ mois: 'Jan', pourcentage: 0 }],
            exceptionnel: [{ mois: 'Jan', pourcentage: 0 }],
            customerService: [{ mois: 'Jan', pourcentage: 0 }],
            planning: [{ mois: 'Jan', pourcentage: 0 }],
            fiveS: [{ mois: 'Jan', pourcentage: 0 }],
            gemba: [{ mois: 'Jan', pourcentage: 0 }]
        };

        // Function definitions in global scope
        function handleLogin() {
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { auth, signInWithEmailAndPassword } = firebaseServices;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginContainer = document.getElementById('login-container');
            const navbar = document.getElementById('navbar');
            const dashboard = document.getElementById('dashboard');

            if (!loginContainer || !navbar || !dashboard) {
                console.error('Required DOM elements missing');
                alert('Application error: Required elements not found.');
                return;
            }

            signInWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    userRole = email.startsWith('logistique@') ? 'logistique' : email.startsWith('user@') ? 'user' : null;
                    if (!userRole) {
                        firebaseServices.signOut(auth);
                        alert('Invalid user role. Please use a valid logistique@ or user@ email.');
                        return;
                    }
                    loginContainer.classList.remove('active');
                    dashboard.classList.add('active');
                    currentPage = 'dashboard';
                    if (userRole === 'logistique') {
                        navbar.classList.add('active');
                        document.querySelectorAll('.logistique-only').forEach(el => el.style.display = 'block');
                        document.querySelectorAll('.logistique-inputs').forEach(el => el.style.display = 'block');
                        document.querySelectorAll('.user-only').forEach(el => el.style.display = 'none');
                        console.log('Logistique: Logged in, showing dashboard');
                    } else {
                        navbar.classList.remove('active');
                        document.querySelectorAll('.logistique-only').forEach(el => el.style.display = 'none');
                        document.querySelectorAll('.logistique-inputs').forEach(el => el.style.display = 'none');
                        document.querySelectorAll('.user-only').forEach(el => el.style.display = 'block');
                        console.log('User: Logged in, starting continuous page cycle');
                        startPageCycle();
                    }
                    initializeFirestore();
                })
                .catch(error => {
                    console.error('Login error:', error);
                    alert('Login failed: ' + error.message);
                });
        }

        function resetPassword() {
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { auth, sendPasswordResetEmail } = firebaseServices;
            const email = document.getElementById('email').value;
            if (!email) {
                alert('Please enter your email to reset password.');
                return;
            }
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert('Password reset email sent. Check your inbox.');
                })
                .catch(error => {
                    console.error('Password reset error:', error);
                    alert('Failed to send password reset email: ' + error.message);
                });
        }

        function handleLogout() {
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { auth, signOut } = firebaseServices;
            signOut(auth)
                .then(() => {
                    document.querySelectorAll('.dashboard-container, .page').forEach(page => page.classList.remove('active'));
                    const navbar = document.getElementById('navbar');
                    const loginContainer = document.getElementById('login-container');
                    if (navbar) navbar.classList.remove('active');
                    if (loginContainer) loginContainer.classList.add('active');
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                    if (currentChart) {
                        currentChart.destroy();
                        currentChart = null;
                    }
                    userRole = null;
                    currentPage = 'dashboard';
                    if (pageCycleInterval) {
                        clearInterval(pageCycleInterval);
                        pageCycleInterval = null;
                    }
                    console.log('Logged out');
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                });
        }

        function showPage(pageId) {
            if (userRole !== 'logistique') {
                console.warn('showPage called but userRole is not "logistique"');
                return;
            }
            document.querySelectorAll('.dashboard-container, .page').forEach(page => page.classList.remove('active'));
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
                currentPage = pageId;
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                console.log(`Logistique: Navigated to ${pageId}`);
            } else {
                console.error(`Logistique: Page element ${pageId} not found`);
            }
        }

        function validateInput(id, type, min, max) {
            const input = document.getElementById(id);
            if (!input) {
                console.error(`Input element ${id} not found`);
                alert(`Input ${id} not found`);
                return false;
            }
            const value = input.value;
            if (!value) {
                alert(`${id} is required`);
                return false;
            }
            if (type === 'number' && (isNaN(value) || value < min || (max !== undefined && value > max))) {
                alert(`${id} must be between ${min} and ${max !== undefined ? max : 'infinity'}`);
                return false;
            }
            return true;
        }

        function validateMonth(id) {
            const input = document.getElementById(id);
            if (!input) {
                console.error(`Select element ${id} not found`);
                alert(`Month selection ${id} not found`);
                return false;
            }
            const value = input.value;
            if (!value) {
                alert(`Please select a month for ${id}`);
                return false;
            }
            return true;
        }

        function submitExportData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('besoin', 'number', 1, undefined) || 
                !validateInput('quantite', 'number', 0, undefined) || 
                !validateInput('reste', 'number', 0, undefined) || 
                !validateMonth('mois-export')) return;
            const besoin = parseFloat(document.getElementById('besoin').value);
            const quantite = parseFloat(document.getElementById('quantite').value);
            const reste = parseFloat(document.getElementById('reste').value);
            if (quantite + reste > besoin) {
                alert('La somme de QuantitÃ© RÃ©alisÃ©e et Reste ne peut pas dÃ©passer QuantitÃ© PlanifiÃ©e');
                return;
            }
            const selectedMonth = document.getElementById('mois-export').value;
            const mois = monthMapping[selectedMonth];
            const data = {
                mois: mois,
                article: document.getElementById('article').value || '',
                besoin: besoin,
                quantite: quantite,
                reste: reste
            };
            addDoc(collection(db, 'export'), data)
                .then(() => {
                    console.log('Logistique: Export data submitted', data);
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page1') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting export data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitAccidentData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-accident', 'number', 0, 100) || !validateMonth('mois-accident')) return;
            const selectedMonth = document.getElementById('mois-accident').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-accident').value) || 0;
            addDoc(collection(db, 'accident'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Accident data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page2') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting accident data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitIncidentData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-incident', 'number', 0, 100) || !validateMonth('mois-incident')) return;
            const selectedMonth = document.getElementById('mois-incident').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-incident').value) || 0;
            addDoc(collection(db, 'incident'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Incident data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page3') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting incident data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitCamionData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-camion', 'number', 0, 100) || !validateMonth('mois-camion')) return;
            const selectedMonth = document.getElementById('mois-camion').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-camion').value) || 0;
            addDoc(collection(db, 'camion'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Camion data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page4') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting camion data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitTransportCostData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-transport-cost', 'number', 0, 100) || !validateMonth('mois-transport-cost')) return;
            const selectedMonth = document.getElementById('mois-transport-cost').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-transport-cost').value) || 0;
            addDoc(collection(db, 'transportCost'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Transport Cost data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page5') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting transport cost data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitExceptionnelData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-exceptionnel', 'number', 0, 100) || !validateMonth('mois-exceptionnel')) return;
            const selectedMonth = document.getElementById('mois-exceptionnel').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-exceptionnel').value) || 0;
            addDoc(collection(db, 'exceptionnel'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Exceptionnel data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page6') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting exceptionnel data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitCustomerServiceData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-customer-service', 'number', 0, 100) || !validateMonth('mois-customer-service')) return;
            const selectedMonth = document.getElementById('mois-customer-service').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-customer-service').value) || 0;
            addDoc(collection(db, 'customerService'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Customer Service data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page7') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting customer service data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitPlanningData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-planning', 'number', 0, 100) || !validateMonth('mois-planning')) return;
            const selectedMonth = document.getElementById('mois-planning').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-planning').value) || 0;
            addDoc(collection(db, 'planning'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Planning data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page8') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting planning data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submit5SData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-5s', 'number', 0, 100) || !validateMonth('mois-5s')) return;
            const selectedMonth = document.getElementById('mois-5s').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-5s').value) || 0;
            addDoc(collection(db, 'fiveS'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: 5S data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page9') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting 5S data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function submitGembaData() {
            if (userRole !== 'logistique') return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, addDoc, collection } = firebaseServices;
            if (!validateInput('pourcentage-gemba', 'number', 0, 100) || !validateMonth('mois-gemba')) return;
            const selectedMonth = document.getElementById('mois-gemba').value;
            const mois = monthMapping[selectedMonth];
            const pourcentage = parseFloat(document.getElementById('pourcentage-gemba').value) || 0;
            addDoc(collection(db, 'gemba'), { mois, pourcentage })
                .then(() => {
                    console.log('Logistique: Gemba data submitted', { mois, pourcentage });
                    alert('Data submitted successfully!');
                    document.querySelectorAll('.logistique-inputs input, .logistique-inputs select').forEach(input => input.value = '');
                    if (userRole === 'user' && currentPage === 'page10') showDefaultCharts();
                })
                .catch(error => {
                    console.error('Error submitting gemba data:', error);
                    alert('Failed to submit data: ' + error.message);
                });
        }

        function startPageCycle() {
            if (userRole !== 'user') {
                console.warn('startPageCycle called but userRole is not "user"');
                return;
            }

            const pages = ['dashboard', 'page1', 'page2', 'page3', 'page4', 'page5', 'page6', 'page7', 'page8', 'page9', 'page10'];
            let currentIndex = 0;

            function showNextPage() {
                document.querySelectorAll('.dashboard-container, .page').forEach(page => page.classList.remove('active'));
                currentPage = pages[currentIndex];
                const nextPageElement = document.getElementById(currentPage);
                
                if (nextPageElement) {
                    nextPageElement.classList.add('active');
                    console.log(`User: Cycled to page ${currentPage} at ${new Date().toLocaleTimeString()}`);
                    if (['page1', 'page2', 'page3', 'page4', 'page5', 'page6', 'page7', 'page8', 'page9', 'page10'].includes(currentPage)) {
                        try {
                            showDefaultCharts();
                        } catch (error) {
                            console.error(`User: Error rendering chart for ${currentPage}:`, error);
                        }
                    }
                } else {
                    console.error(`User: Page element ${currentPage} not found`);
                }
                currentIndex = (currentIndex + 1) % pages.length;
            }

            if (pageCycleInterval) {
                clearInterval(pageCycleInterval);
                pageCycleInterval = null;
            }
            showNextPage();
            pageCycleInterval = setInterval(showNextPage, 10000);
            console.log('User: Continuous page cycling started with 10-second interval');
        }

        function getColor(value) {
            if (value >= 80) return '#00ff00';
            if (value >= 50) return '#ffcc00';
            return '#ff0000';
        }

        function showDefaultCharts() {
            if (userRole !== 'user' || !['page1', 'page2', 'page3', 'page4', 'page5', 'page6', 'page7', 'page8', 'page9', 'page10'].includes(currentPage)) return;
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, getDocs, collection } = firebaseServices;
            if (currentChart) {
                try {
                    currentChart.destroy();
                } catch (error) {
                    console.warn('User: Error destroying previous chart:', error);
                }
                currentChart = null;
            }
            console.log(`User: Attempting to render chart for ${currentPage} at ${new Date().toLocaleTimeString()}`);

            const chartConfigs = [
                { 
                    id: 'exportChart', 
                    page: 'page1', 
                    key: 'export', 
                    type: 'bar', 
                    title: 'Avancement Export: RÃ©alisation vs PlanifiÃ© (%)'
                },
                { 
                    id: 'accidentChart', 
                    page: 'page2', 
                    key: 'accident', 
                    type: 'bar', 
                    title: 'Accident de Travail: Taux par Mois (%)'
                },
                { 
                    id: 'incidentChart', 
                    page: 'page3', 
                    key: 'incident', 
                    type: 'bar', 
                    title: 'Incident Logistique: Taux par Mois (%)'
                },
                { 
                    id: 'camionChart', 
                    page: 'page4', 
                    key: 'camion', 
                    type: 'bar', 
                    title: 'Suivi Remplissage Camion: Taux par Mois (%)'
                },
                { 
                    id: 'transportCostChart', 
                    page: 'page5', 
                    key: 'transportCost', 
                    type: 'bar', 
                    title: 'CoÃ»t Total du Transport vs Ventes (%)'
                },
                { 
                    id: 'exceptionnelChart', 
                    page: 'page6', 
                    key: 'exceptionnel', 
                    type: 'bar', 
                    title: 'CoÃ»t Exceptionnel du Transport (%)'
                },
                { 
                    id: 'customerServiceChart', 
                    page: 'page7', 
                    key: 'customerService', 
                    type: 'bar', 
                    title: 'Taux de Service Client (%)'
                },
                { 
                    id: 'planningChart', 
                    page: 'page8', 
                    key: 'planning', 
                    type: 'bar', 
                    title: 'Taux de Respect du Planning (%)'
                },
                { 
                    id: 'fiveSChart', 
                    page: 'page9', 
                    key: 'fiveS', 
                    type: 'bar', 
                    title: 'Suivi 5S: ConformitÃ© par Mois (%)'
                },
                { 
                    id: 'gembaChart', 
                    page: 'page10', 
                    key: 'gemba', 
                    type: 'bar', 
                    title: 'Suivi Gemba OJT: Progression par Mois (%)'
                }
            ];

            const config = chartConfigs.find(c => c.page === currentPage);
            if (!config) {
                console.error(`User: No chart config found for ${currentPage}`);
                return;
            }

            const canvas = document.getElementById(config.id);
            if (!canvas) {
                console.error(`User: Canvas element ${config.id} not found`);
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`User: Canvas context for ${config.id} not available`);
                return;
            }

            const fontSize = clamp(14, window.innerWidth * 0.01, 24);
            const titleFontSize = clamp(16, window.innerWidth * 0.015, 28);
            const barBorderWidth = clamp(1, window.innerWidth * 0.001, 3);

            getDocs(collection(db, config.key))
                .then(snapshot => {
                    const data = snapshot.empty ? [{ mois: 'Jan', quantite: 0, reste: 0, pourcentage: 0, besoin: 0, article: '' }] : snapshot.docs.map(doc => doc.data());
                    let datasets = [];
                    let tooltipCallbacks = {};

                    if (config.key === 'export') {
                        datasets = [
                            {
                                label: 'QuantitÃ© RÃ©alisÃ©e (%)',
                                data: data.map(item => item.besoin > 0 ? (item.quantite / item.besoin * 100).toFixed(1) : 0),
                                backgroundColor: data.map(item => getColor(item.besoin > 0 ? (item.quantite / item.besoin * 100) : 0)),
                                borderColor: '#e63946',
                                borderWidth: barBorderWidth
                            },
                            {
                                label: 'Reste (%)',
                                data: data.map(item => item.besoin > 0 ? (item.reste / item.besoin * 100).toFixed(1) : 0),
                                backgroundColor: data.map(item => getColor(item.besoin > 0 ? (item.reste / item.besoin * 100) : 0)),
                                borderColor: '#4b5e6a',
                                borderWidth: barBorderWidth
                            },
                            {
                                label: 'Taux de RÃ©alisation (%)',
                                data: data.map(item => item.besoin > 0 ? (item.quantite / item.besoin * 100).toFixed(1) : 0),
                                backgroundColor: data.map(item => getColor(item.besoin > 0 ? (item.quantite / item.besoin * 100) : 0)),
                                borderColor: '#00cc00',
                                borderWidth: barBorderWidth
                            }
                        ];
                        tooltipCallbacks = {
                            title: context => {
                                const item = data[context[0].dataIndex];
                                return `Mois: ${Object.keys(monthMapping).find(key => monthMapping[key] === item.mois) || item.mois}`;
                            },
                            label: context => {
                                const item = data[context.dataIndex];
                                const percentage = item.besoin > 0 ? (item.quantite / item.besoin * 100).toFixed(1) : 0;
                                return [
                                    `Article: ${item.article || 'N/A'}`,
                                    `PlanifiÃ©: ${item.besoin || 0}`,
                                    `RÃ©alisÃ©: ${item.quantite || 0}`,
                                    `Reste: ${item.reste || 0}`,
                                    `Taux de RÃ©alisation: ${percentage}%`
                                ];
                            }
                        };
                    } else {
                        datasets = [
                            {
                                label: 'Pourcentage (%)',
                                data: data.map(item => item.pourcentage),
                                backgroundColor: data.map(item => getColor(item.pourcentage)),
                                borderColor: '#e63946',
                                borderWidth: barBorderWidth
                            }
                        ];
                        tooltipCallbacks = {
                            title: context => {
                                const item = data[context[0].dataIndex];
                                return `Mois: ${Object.keys(monthMapping).find(key => monthMapping[key] === item.mois) || item.mois}`;
                            },
                            label: context => `${context.dataset.label}: ${context.raw}%`
                        };
                    }

                    currentChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(item => {
                                const frenchMonth = Object.keys(monthMapping).find(key => monthMapping[key] === item.mois) || item.mois;
                                return frenchMonth;
                            }),
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            devicePixelRatio: window.devicePixelRatio,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Pourcentage (%)',
                                        font: { size: titleFontSize }
                                    },
                                    grid: { color: '#ddd' },
                                    ticks: { 
                                        font: { size: fontSize },
                                        callback: value => `${value}%`
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Mois',
                                        font: { size: titleFontSize }
                                    },
                                    grid: { display: false },
                                    ticks: { font: { size: fontSize } }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        font: { size: fontSize },
                                        padding: clamp(10, window.innerWidth * 0.01, 20)
                                    }
                                },
                                title: {
                                    display: true,
                                    text: config.title,
                                    font: { size: titleFontSize },
                                    padding: clamp(10, window.innerWidth * 0.01, 20)
                                },
                                tooltip: {
                                    bodyFont: { size: fontSize },
                                    titleFont: { size: titleFontSize },
                                    callbacks: tooltipCallbacks
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    font: { size: fontSize },
                                    formatter: (value, context) => `${value}%`,
                                    color: '#333'
                                },
                                annotation: {
                                    annotations: {
                                        targetLine: {
                                            type: 'line',
                                            yMin: 80,
                                            yMax: 80,
                                            borderColor: '#00ff00',
                                            borderWidth: clamp(1, window.innerWidth * 0.001, 3),
                                            label: {
                                                content: 'Cible: 80%',
                                                enabled: true,
                                                position: 'end',
                                                font: { size: fontSize },
                                                padding: clamp(5, window.innerWidth * 0.005, 10)
                                            }
                                        }
                                    }
                                }
                            },
                            barPercentage: config.key === 'export' ? 0.3 : 0.4,
                            categoryPercentage: config.key === 'export' ? 0.9 : 0.8
                        },
                        plugins: [ChartDataLabels]
                    });
                    console.log(`User: Rendered bar chart for ${currentPage}`, data);
                })
                .catch(error => {
                    console.error(`User: Failed to render chart for ${currentPage}:`, error);
                    alert('Failed to render chart: ' + error.message);
                });
        }

        function initializeFirestore() {
            if (!firebaseServices) {
                alert('Firebase services not initialized. Please try again.');
                return;
            }
            const { db, collection, addDoc, getDocs, auth } = firebaseServices;
            if (!auth.currentUser || !auth.currentUser.email.startsWith('logistique@')) {
                console.warn('Firestore initialization skipped: User is not authenticated or not a logistique user');
                return;
            }
            Promise.all(Object.entries(defaultData).map(([key, data]) => {
                return getDocs(collection(db, key)).then(snapshot => {
                    if (snapshot.empty) {
                        console.log(`Initializing Firestore collection: ${key}`);
                        return Promise.all(data.map(item => 
                            addDoc(collection(db, key), item)
                                .catch(error => {
                                    console.error(`Error adding document to ${key}:`, error);
                                    throw error;
                                })
                        ));
                    } else {
                        console.log(`Collection ${key} already initialized`);
                    }
                });
            }))
            .then(() => {
                console.log('Firestore initialization completed successfully');
            })
            .catch(error => {
                console.error('Error initializing Firestore:', error);
                alert(`Failed to initialize data: ${error.message}`);
            });
        }

        function clamp(min, val, max) {
            return Math.min(Math.max(val, min), max);
        }

        document.addEventListener('DOMContentLoaded', () => {
            firebaseServices = window.firebaseServices;
            if (!firebaseServices) {
                console.error('Firebase services not initialized');
                alert('Firebase services not initialized. Please refresh the page.');
                return;
            }

            const { onAuthStateChanged, auth } = firebaseServices;

            onAuthStateChanged(auth, user => {
                if (!user && currentPage !== 'login-container') {
                    handleLogout();
                }
            });

            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('nav-menu');

            if (hamburger && navMenu) {
                hamburger.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                    console.log('Logistique: Hamburger menu toggled');
                });
            } else {
                console.warn('Hamburger or navMenu elements not found');
            }
        });
    </script>
</body>
</html>
